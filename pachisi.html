<!DOCTYPE html>
<html>
<head>
<title>Pachisi</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script>
Array.prototype.first = function() {
	return this[0];
}
Array.prototype.last = function() {
	return this[this.length-1];
}

// расстояние между пользователями
var q = 17;

var Dice = function() {
	this.pair = [null, null];
	self = this;
	this.drop = function() {
		for (var i = 0; i < self.pair.length; i++) {
			self.pair[i] = Math.round(Math.random() * 5 + 1);
		}
	}
}

// фишка
var Chip = function(player) {
	// связь с игроком
	this.player = player;
	// связь с ячейкой
	this.cell = null;
	var self = this;
	// переход фишки к ячейке
	// !!! проверки на возможность перехода должны осуществляться ранее
	this.go = function(to_cell) {
		if (self.cell) {
			for (var i = 0; i < self.cell.places.length; i++) {
				if (self.cell.places[i] == self) {
					self.cell.places[i] = null;
					break;
				}
			}
		}
		self.cell = to_cell;
		for (var i = 0; i < self.cell.places.length; i++) {
			if (!self.cell.places[i]) {
				self.cell.places[i] = self;
				break;
			}
		}
	}
};

// игрок
var Player = function(ind, ai, color) {
	// глобальный номер игрока
	this.ind = ind;
	// номер стартовой для текущего игрока ячейки на общей доске
	this.i_begin = q * ind;
	// номер конечной для текущего игрока ячейки на общей доске
	this.i_end = q * ind + 63;
	// компьютер или человек (Artifical Intelligent)
	this.ai = ai;
	// цвет игрока
	this.color = color;
	// фишки игрока
	this.chips = [
		new Chip(this),
		new Chip(this),
		new Chip(this),
		new Chip(this),
	];
	// доски игрока
	this.boards = [
		new Board(0, this, 1, null, null, {0: 4}),
		null,
		new Board(2, this, 8, null, null, {7: 4})
	];
	// расставляем фишки
	var self = this;
	this.chips.forEach(function(ch){
		ch.go(self.boards[0].cells[0]);
	});
};

// ячейка доски
var Cell = function(board, safe, io, size) {
	this.board = board;
	// флаг островка безопасности
	this.safe = safe || false;
	// связанная ячейка перехода (input/output)
	this.io = io || null;
	// кол-во мест в ячейке
	this.size = size || 2;
	// места в ячейке
	this.places = [];
	for (var i = 0; i < this.size; i++) {
		this.places.push(null);
	}
};

// доска
var Board = function(ind, player, len, safes, ios, sizes) {
	// глобальный индекс доски
	this.ind = ind;
	// связь с игроком, если нужно
	this.player = player;
	// ячейки доски
	this.cells = [];
	// безопасные ячейки
	safes = safes || {};
	// переходные ячейки
	ios = ios || {};
	// размеры ячеек
	sizes = sizes || {};
	for (var i = 0; i < len; i++) {
		this.cells.push(new Cell(this, safes[i], ios[i], sizes[i]));
	};
};

// массив игроков
var players = [
	new Player(0, false, 'green'),
	new Player(1, true, 'yellow'),
	new Player(2, true, 'red'),
	new Player(3, true, 'blue'),
];

// карта ячеек безопасности
var safes = {
	0: players[0],
	7: true,
	12: true,
	17: players[1],
	24: true,
	29: true,
	34: players[2],
	41: true,
	46: true,
	51: players[3],
	58: true,
	63: true
};

// карта ячеек-переходов
var ios = {
	0: players[0].boards[0].cells.last(),
	12: players[1].boards[2].cells.first(),
	17: players[1].boards[0].cells.last(),
	29: players[2].boards[2].cells.first(),
	34: players[2].boards[0].cells.last(),
	46: players[3].boards[2].cells.first(),
	51: players[3].boards[0].cells.last(),
	63: players[0].boards[2].cells.first()
};

//общая глобальная доска
var board = new Board(1, null, 68, safes, ios);

// связь игорков с общей доской и связи ячеек-преходов с общей доской
players.forEach(function(player){
	player.boards[0].cells.last().io = board.cells[player.i_begin];
	player.boards[1] = board;
	player.boards[2].cells.first().io = board.cells[player.i_end];
});

// ...

// перерисовка
function paint() {
	var $board_cells = $('#board_cells');
	$board_cells.html('');
	var $tpl_cell = $('#tpl_cell').clone(true, true).removeAttr('id');
	var $tpl_place_tpl = $tpl_cell.find('.place');
	var $tpl_place = $tpl_place_tpl.clone(true, true).show();
	$tpl_place_tpl.remove();
	board.cells.forEach(function(cell){
		var $cell = $tpl_cell.clone(true, true);
		var $places = $cell.find('.place-cells');
		var $place = $tpl_place.clone(true, true);
		for (var i = 0; i < cell.size; i++) {
			var pl = $place.clone(true, true).addClass('place_'+i);
			if (cell.places[i]) {
				pl.addClass('chip-'+cell.places[i].player.color);
			}
			$places.append(pl);
		}
		if (cell.safe) {
			$cell.addClass('safe');
			if (cell.safe.constructor == Player) {
				$cell.css('backgroundColor', cell.safe.color);
			}
		}
		if (cell.io) {
			var $subboard = $cell.find('.cell-'+['in', '', 'out'][cell.io.board.ind]);
			cell.io.board.cells.forEach(function(cell2){
				var $subcell = $tpl_cell.find('.place-cells').clone(true, true).css('backgroundColor', cell.io.board.player.color);
				for (var i = 0; i < cell2.size; i++) {
					var pl = $tpl_place.clone(true, true).addClass('place_'+i);
					if (cell2.places[i]) {
						pl.addClass('chip-'+cell2.places[i].player.color);
					}
					$subcell.append(pl);
				}
				$subboard.append($subcell);
			});
		}
		$board_cells.append($cell);
	});
}

$(function(){
	// drawing...
	paint();
});

</script>
<style>
#board_cells {
	list-style: none;
	margin: 0;
	padding: 0;
	overflow: hidden;
}
#board_cells li {
	margin: 3px;
	padding: 0;
	float: left;
	width: 10px;
	background-color: #eee;
}
#board_cells li.safe {
	background-color: #ddd;
}
#board_cells li div {
	float: left;
}
#board_cells li .cell-in, #board_cells li .cell-out {
	width: 100%;
	background-color: #fff;
	font-size: 12px;
	font-weight: bold;
	text-align: center;
}
#board_cells li .cell-in {
	height: 70px;
}
#board_cells li .cell-out {
	height: 340px;
}
#board_cells li .place-cells {
	margin: 5px 0;
	width: 100%;
}
#board_cells li .place-cells div {
	width: 60%;
	height: 10px;
	margin: 2px 20%;
	background-color: #fff;
}
#board_cells li .place-cells div.chip-green {
	border: 1px solid white;
	background-color: green;
}
#board_cells li .place-cells div.chip-yellow {
	border: 1px solid white;
	background-color: yellow;
}
#board_cells li .place-cells div.chip-red {
	border: 1px solid white;
	background-color: red;
}
#board_cells li .place-cells div.chip-blue {
	border: 1px solid white;
	background-color: blue;
}
</style>
</head>
<body>
	<ul id="tpl_board_cells" style="display: none;">
		<li id="tpl_cell">
			<div class="cell-in"></div>
			<div class="place-cells">
				<div class="place" style="display: none;"></div>
			</div>
			<div class="cell-out"></div>
		</li>
	</ul>
	<ul id="board_cells">
	</ul>
</body>
</html>